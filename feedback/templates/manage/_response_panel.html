{% load i18n %}
{% load bootstrap %}
{% load feedback %}
{% comment %}
	expects to be used under bootstrapped.html
	expects from context:
		form
		feedback
		post_url
{% endcomment %}

<div class="panel panel-primary" id="{{ form.auto_id|fill_format_string:"panel" }}">
	<div class="panel-heading">
		Response
		{% if form.disabled %}
			<span class="label label-warning pull-right">Superseded</span>
		{% endif %}
	</div>

	<div class="panel-body">
		<form
			id="{{ form.auto_id|fill_format_string:"form" }}"
			data-footer-id="{{ form.auto_id|fill_format_string:"footer" }}"
			data-state-id="{{ form.auto_id|fill_format_string:"state" }}"
			data-panel-id="{{ form.auto_id|fill_format_string:"panel" }}"
			action="{{ post_url }}"
			method="post"
			class="form-horizontal ajax-form"
			role="form">
			{% csrf_token %}

			{% include "_errors_box.html" with errors=form.non_field_errors %}

			{% for field in form.hidden_fields %}
				{% include "_errors_box.html" with errors=field.errors %}
				{{ field }}
			{% endfor %}

			{% with f=form.response_msg %}
				{% include "_errors_box.html" with errors=f.errors %}
				<div class="col-xs-12">
					<div class="form-group {% if f.errors %}has-error{% endif %}">
						<textarea
							id={{ f.id_for_label }}
							class="form-control track-change"
							name="response_msg"
							placeholder="{{ f.label }}"
							{% if f.field.disabled %} disabled="disabled" {% endif %}
							rows="4"
							>{{ f.value|default:'' }}</textarea>
					</div>
				</div>
			{% endwith %}

			{% with f=form.response_grade %}
				{% include "_errors_box.html" with errors=f.errors classes="col-xs-12" %}
				<div class="form-group submit-on-click" style="margin-bottom: 0;">
					<div class="col-xs-10">
						<div class="btn-group btn-group-justified add-check" data-toggle="buttons">
							{% for c in f %}
								<label
									class="btn
									btn-{{ c.choice_value|grade_color }}
									{% if form.disabled %}disabled{% endif %}
									{% if c.value == c.choice_value and form.instance.responded %}active{% endif %}
									">
									<input
										type="radio"
										name="{{ f.name }}"
										value="{{ c.choice_value }}"
										{% if c.value == c.choice_value and form.instance.responded %} checked='checked' {% endif %}
										{% if form.disabled %} disabled="disabled" {% endif %}
										/>
									{{ c.choice_label }}
								</label>
							{% endfor %}
						</div>
					</div>
					<div class="col-xs-2">
						<input
							type="submit"
							class="btn btn-primary pull-right"
							data-responded="{{ form.instance.responded|yesno:"1,0" }}"
							value="{% if form.had.responded %}Update{% else %}Respond{% endif %}"
							{% if form.disabled %} disabled="disabled" {% endif %}
							/>
					</div>
				</div>
			{% endwith %}
		</form>
	</div>

	<div class="panel-footer" id="{{ form.auto_id|fill_format_string:"footer" }}">
		{% if form.has_expired %}
			<span
				id="{{ form.auto_id|fill_format_string:"state" }}"
				class="label label-default"
				>Conflict</span>
		{% else %}
			{% with grade=form.had.response_grade_text color=form.had.valid_response_grade|grade_color %}
				<span
					id="{{ form.auto_id|fill_format_string:"state" }}"
					class="label label-{{ color }}"
					data-orig-style="label-{{ color }}"
					data-orig-text="{{ grade }}"
					>{{ grade }}</span>
			{% endwith %}
			<button
				class="btn btn-danger btn-xs reset-button"
				data-form-id="{{ form.auto_id|fill_format_string:"form" }}"
				style="display: none;"
				>Reset</button>
			{% if form.had.responded %}
				<span class="response-time">{{ form.had.response_time }}</span>
			{% endif %}
		{% endif %}
	</div>
</div>
